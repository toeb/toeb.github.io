<!DOCTYPE html>
<html lang="en-us">
<head>
    

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-177198277-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-177198277-1');
    </script>


    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="toeb&#39;s Blog">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://toeb.github.io//images/carbon.png">
    <meta property="twitter:image" content="https://toeb.github.io//images/carbon.png" />
    

    
    <meta name="title" content="Parallel Processes in CMake" />
    <meta property="og:title" content="Parallel Processes in CMake" />
    <meta property="twitter:title" content="Parallel Processes in CMake" />
    

    
    <meta name="description" content="">
    <meta property="og:description" content="" />
    <meta property="twitter:description" content="" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="thetoeb, toeb, blog, programming">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Parallel Processes in CMake-Toeb Blog</title>

    <link rel="canonical" href="/post/cmakeppparallelprocesses/">

    <link rel="stylesheet" href="/css/iDisqus.min.css"/>
	
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">
    
    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    
    

    
    
    <script src="/js/jquery.min.js"></script>
    
    
    <script src="/js/bootstrap.min.js"></script>
    
    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>



<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">toeb&#39;s Blog</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/tech">tech</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/about/">ABOUT</a></li>
                    

                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/images/carbon.png')
    }
</style>
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                    </div>
                    <h1>Parallel Processes in CMake</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by 
                        
                                toeb&#39;s Blog
                         
                        on 
                        Tuesday, August 30, 2016
                        
                        
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                post-container">

                
                <p>Parallel Processes in CMake
by thetoeb • 2014/12/16 • 0 Comments</p>
<p>If you need to check out multiple large repositories or build and install large separate projects you might want to use parallel processes in CMake. Dividing your tasks to use multiple CMake and or other processes can speed up your build and configuration steps immensely.</p>
<p>Since all cmake host OSs support multitasking from the command line it is possible to use cmake to contol them in turn. Using this approach I implemented a ‘platform independent’ control mechanism for starting, killing, querying and waiting for processes. Only the very basic functions are platform specific and the others are based on the abstraction layer that they provide.</p>
<p>As of now platforms which support bash or powershell are supported.</p>
<p>The functions are part of my cmake enhancement suite – oocmake and can be found at my github repository <a href="https://github.com/toeb/oo-cmake">https://github.com/toeb/oo-cmake</a>. Please report any issues you might have or contribute. (I am also happy if you just give me feedback)</p>
<p>Installation is very easy and described in the README.md</p>
<p>Examples
Of course example are the easiest to show what is possible therefore I provided two:</p>
<p>This example starts a script into three separate cmake processes. The program ends when all scripts are done executing.</p>
<h1 id="define-a-script-which-counts-to-10-and-then">define a script which counts to 10 and then</h1>
<h1 id="note-that-a-fresh-process-means-that-cmake-has-not-loaded-oocmake">note that a fresh process means that cmake has not loaded oocmake</h1>
<p>set(script &quot;
foreach(i RANGE 0 10)
message(${i})
execute_process(COMMAND ${CMAKE_COMMAND} -E sleep 1)
endforeach()
message(end)
&ldquo;)</p>
<h1 id="start-each-script---fork_script-returns-without-waiting-for-the-process-to-finish">start each script - fork_script returns without waiting for the process to finish.</h1>
<h1 id="a-handle-to-the-created-process-is-returned">a handle to the created process is returned.</h1>
<p>process_start_script(&quot;${script}&quot;)
ans(handle1)
process_start_script(&quot;${script}&quot;)
ans(handle2)
process_start_script(&quot;${script}&quot;)
ans(handle3)</p>
<h1 id="wait-for-every-process-to-finish-returns-the-handles-in-order-in-which-the-process-finishes">wait for every process to finish. returns the handles in order in which the process finishes</h1>
<p>process_wait_all(${handle1} ${handle2} ${handle3})
ans(res)</p>
<h2 id="print-the-process-handles-in-order-of-completion">print the process handles in order of completion</h2>
<p>json_print(${res})
This example shows a slightly less useless case: Downloading multiple ‘large’ files in parallel to save time</p>
<h2 id="define-a-function-which-downloads">define a function which downloads</h2>
<h2 id="all-urls-specified-to-the-current-dir">all urls specified to the current dir</h2>
<h2 id="returns-the-path-for-every-downloaded-files">returns the path for every downloaded files</h2>
<p>function(download_files_parallel)
## get current working dir
pwd()
ans(target_dir)</p>
<pre><code>## process start loop 
## starts a new process for every url to download
set(handles)
foreach(url ${ARGN})
  ## start download by creating a cmake script
  process_start_script(&quot;
    include(${oocmake_base_dir}/oo-cmake.cmake) # include oocmake
    download(\&quot;${url}\&quot; \&quot;${target_dir}\&quot;)
    ans(result_path)
    message(STATUS ${target_dir}/\${result_path})
    &quot;)
  ans(handle)
  ## store process handle 
  list(APPEND handles ${handle})
endforeach()

## wait for all downloads to finish
process_wait_all(${handles})

set(result_paths)
foreach(handle ${handles})
  ## get process stdout
  process_stdout(${handle})
  ans(output)

  ## remove '-- ' from beginning of output which is
  ## automatically prependend by message(STATUS) 
  string(SUBSTRING &quot;${output}&quot; 3 -1 output)

  ## store returned file path
  list(APPEND result_paths ${output})

endforeach()

## return file paths of downloaded files
return_ref(result_paths)
</code></pre>
<p>endfunction()</p>
<h2 id="create-and-goto-download_dir">create and goto ./download_dir</h2>
<p>cd(&ldquo;download_dir&rdquo; &ndash;create)</p>
<h2 id="start-downloading-files-in-parallel-by-calling-previously-defined-function">start downloading files in parallel by calling previously defined function</h2>
<p>download_files_parallel(
<a href="http://www.cmake.org/files/v3.0/cmake-3.0.2.tar.gz">http://www.cmake.org/files/v3.0/cmake-3.0.2.tar.gz</a>
<a href="http://www.cmake.org/files/v2.8/cmake-2.8.12.2.tar.gz">http://www.cmake.org/files/v2.8/cmake-2.8.12.2.tar.gz</a>
)
ans(paths)</p>
<h2 id="assert-that-every-the-files-were-downloaded">assert that every the files were downloaded</h2>
<p>foreach(path ${paths})
assert(EXISTS &ldquo;${path}&quot;)
endforeach()
Functions and Datatypes
datatypes
<process handle> ::= { state:<process state> , pid:<process id> } process handle is a runtime unique map which is used to address a process. The process handle may contain more properties than specified – only the specified ones are available on all systems – these properties contain values which are implementation specific.
<process info> ::= { } a map containing verbose information on a proccess. only the specified fields are available on all platforms. More are available depending on the OS you use. You should not try to use these without examining their origin / validity.
<process state> ::= &ldquo;running&rdquo;|&ldquo;terminated&rdquo;|&ldquo;unknown&rdquo;
<process id> ::= <string> a unspecified systemwide unique string which identifies a process (normally a integer)
platform specific low level functions
process_start(&lt;process start info?!&gt;):<process handle> platfrom specific function which starts a process and returns a process handle
process_kill(&lt;process handle?!&gt;) platform specific function which stops a process.
process_list():&lt;process handle &hellip;&gt; platform specific function which returns a process handle for all running processes on OS.
process_info(&lt;process handle?!&gt;):<process info> platform specific function which returns a verbose process info
process_isrunning(&lt;process handle?!&gt;):<bool> returns true iff process is running.
process_timeout(&lt;n:<seconds>&gt;):<process handle> starts a process which times out in <n> seconds.
process_wait(&lt;process handle~&gt; [&ndash;timeout &lt;n:seconds&gt;]):<process handle> waits for the specified process to finish or the specified timeout to run out. returns null if timeout runs out before process finishes.
process_wait_all(&lt;process handle?!&hellip;&gt; &lt;[&ndash;timeout &lt;n:seconds&gt;] [&ndash;quietly]):&lt;process handle &hellip;&gt; waits for all specified process handles and returns them in the order that they completed. If the &ndash;timeout <n> value is specified the function returns as soon as the timeout is reached returning only the process finished up to that point. The function normally prints status messages which can be supressed via the &ndash;quietly flag.
process_wait_any(&lt;process handle?!&hellip;&gt; &lt;?&quot;&ndash;timeout&rdquo; &lt;n:<seconds>&raquo; &lt;?&quot;&ndash;quietly&rdquo;&gt;):&lt;?process handle&gt; waits for any of the specified processes to finish, returning the handle of the first one to finished. If &ndash;timeout <n> is specified the function will return null after n seconds if no process completed up to that point in time. You can specify &ndash;quietly if you want to suppress the status messages.
process_stdout(&lt;process handle~&gt;):<string> returns all data written to standard output stream of the process specified up to the current point in time
process_stderr(&lt;process handle~&gt;):<string> return all data written to standard error stream of the process specified up to the current point in time
process_return_code(&lt;process handle~&gt;):&lt;int?&gt; returns nothing or the process return code if the process is finished
process_start_script(<cmake code>):<process handle> starts a separate cmake process which runs the specified cmake code.
Inter Process Communication
To communicate with you processes you can use any of the following well known mechanisms</p>
<p>Environment Variables
the started processes have access to you current Environment. So when you call set(ENV{VAR} value) before starting a process that process will have read access to the variable $ENV{VAR}
Command Line Arguments
all variables passed to start_process will be passed allong
Command Line Variables are sometimes problematic as they must be escaped correctly and this does not always happen as expected. So you might want to choose another mechanism to transmit complex data to your process
Command Line Variables are limited by their string length depending on you host os.
Files
Files are the easiest and safest way to communicate large amounts of data to another process. If you can try to use file communication
stderr, stdout
The output of a process started with start_process becomes available to you when the process ends at latest, You can choose to poll stdout and take data as soon as it is written to the output streams
return code
the returns code tells you how you process finished and is often enough result information for a process you start
Caveats
process starting is slow – it can take seconds (it takes 900ms on my machine). The task needs to be a very large one for it to compensate the overhead.
parallel processes use platform specific functions – It might cause problems on less well tested OSs and some may not be supported. (currently only platforms with bash or powershell are supported ie Windows and Linux)</p>


                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/cpprenameablenamespaces/" data-toggle="tooltip" data-placement="top" title="Renameable Namespaces using the Preprocessor">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/cmakeppobjectsandmaps/" data-toggle="tooltip" data-placement="top" title="Objects and Maps in CMake">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>

                
<div id="disqus-comment"></div>



            </div>
            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="toeb&#39;s Blog" >
                           <span class="fa-stack fa-lg">
                               <i class="fa fa-circle fa-stack-2x"></i>
                               <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
                   
                    
                    <li>
                        <a href="mailto:redacted@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    

                    

		    
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/toeb">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/tobias-becker-a64475a3/">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    <li>
                        <a target="_blank" href="https://stackoverflow.com/users/1229468/toeb">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
            
                    
                    <li>
                        <a target="_blank" href="https://www.reddit.com/user/toebi">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-reddit fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
            
                    
                    
            
            
            
                </ul>
		<p class="copyright text-muted">
                    Copyright &copy; toeb&#39;s Blog 2021
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






</body>
</html>
